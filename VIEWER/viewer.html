<!DOCTYPE html>
<html>

<head>
	<title>å°å±±ç¤¾RTIæŸ¥çœ‹å™¨</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="UTF-8" />

	<link rel="icon" type="image/png"
		href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHdpZHRoPSI2MnB4IgogICBoZWlnaHQ9IjYycHgiCiAgIHZpZXdCb3g9IjAgMCA2MiA2MiIKICAgdmVyc2lvbj0iMS4xIj4KICA8Y2lyY2xlCiAgICAgdHJhbnNmb3JtPSJyb3RhdGUoNDUpIgogICAgIHN0eWxlPSJvcGFjaXR5OjE7ZmlsbDojZmFjZDVhO2ZpbGwtb3BhY2l0eToxIgogICAgIGN4PSI0My44NDA2MjIiCiAgICAgY3k9IjAiCiAgICAgcj0iMjguODgxNjk3IiAvPgogIDxwYXRoCiAgICAgZD0ibSAzOC4zOTk2OTUsMjcuMDUxODA5IC03LjkzNjQzNiwtNC42MTIwMjIgLTEuMjY1OTc2LC0xLjI2NTk3NiAtOC4wOTgzOTUsLTguMDk4Mzk1IC0yLjk1NzIzNCwtMi45NTcyMzQgYyAtMC43MDEzNTEsLTAuNzAxMzUwNSAtMS44MzA1OTcsLTAuNzAxMzU0IC0yLjUzMTk0OCwtMmUtNiBsIC01LjA1MzM4Niw1LjA1MzM4NiBjIC0wLjcwMTM1MjYsMC43MDEzNTIgLTAuNzAxMzQ5LDEuODMwNTk4IDNlLTYsMi41MzE5NDggbCAyLjk1NzIzMywyLjk1NzIzNSA4LjA5ODM5NSw4LjA5ODM5NSAxLjI2NTk3NSwxLjI2NTk3NSA0LjYxMjAyMiw3LjkzNjQzNyA1LjY3NDYzLDUuNjc0NjMxIDEwLjkwOTc0OCwtMTAuOTA5NzQ3IHoiCiAgICAgc3R5bGU9ImZpbGw6IzVmODJjMzsiLz4KICA8cGF0aCBkPSJtIDM4LjM5OTY5MiwyNy4wNTE4MTIgMi4yODEwNjksMi4yODEwNyAtMTAuOTA5NzQ0LDEwLjkwOTc0NCAtMi4yODEwNjksLTIuMjgxMDcgeiIKICAgICBzdHlsZT0iZmlsbDojNDE1YTg3OyIvPgogIDxjaXJjbGUKICAgICB0cmFuc2Zvcm09InJvdGF0ZSg0NSkiCiAgICAgcj0iMS43MTg0MjI4IgogICAgIGN5PSItMC4zMDk4MDYyOSIKICAgICBjeD0iMzYuOTc3MjI2IgogICAgIHN0eWxlPSJmaWxsOiMwMDAwMDA7ZmlsbC1vcGFjaXR5OjAuMjQ3NDc0NzYiLz4KICA8cGF0aAogICAgIGQ9Ik0gNTkuMDUzMDkyLDM3LjIwOTcgNDMuMTc3MjMsMzMuNjIzMjI1IDMzLjkwODMwMSw0Mi44OTIxNTMgYyAwLDAgMS45ODAxNjIsOS4yMjExNiAzLjQ0NjE1OSwxNi4xMDA5NTIgQSAyOC44ODE2OTcsMjguODgxNjk3IDAgMCAwIDUxLjMwNDI1OSw1MS4zMDQxOTkgMjguODgxNjk3LDI4Ljg4MTY5NyAwIDAgMCA1OS4wNTMwOTIsMzcuMjA5NyBaIgogICAgIHN0eWxlPSJmaWxsOiNmY2UwOTQ7Ii8+CiAgPHBhdGgKICAgICBkPSJtIDU2Ljc4NTczOCw0My41NzQwMDMgLTE0Ljk1OTA1NCwtOC42MDAyMzIgLTYuNDE0NzMsNi40MTQ3MyA4LjczMzI0MSwxNS4xMzczNzMgYSAyOC44ODE2OTcsMjguODgxNjk3IDAgMCAwIDcuMTU5MDY0LC01LjIyMTY3NSAyOC44ODE2OTcsMjguODgxNjk3IDAgMCAwIDUuNDgxNDc5LC03LjczMDE5NiB6IgogICAgIHN0eWxlPSJmaWxsOiNmZWY5ZDQ7Ii8+Cjwvc3ZnPgo=">
	<link rel="stylesheet" href="skin.css" />

	<style>
		html,
		body {
			margin: 0px;
			padding: 0px;
			height: 100%;
		}

		#openlime {
			position: relative;
			height: 100%
		}

		#openlime>canvas {
			width: 100%;
			height: 100%;
			/* this is important, it would cause firefox flickering! */
			overflow: hidden;
		}

		.error-message {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(255, 0, 0, 0.9);
			color: white;
			padding: 20px;
			border-radius: 10px;
			z-index: 2000;
			text-align: center;
			display: none;
		}

		.loading-message {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(0, 0, 0, 0.8);
			color: white;
			padding: 20px;
			border-radius: 10px;
			z-index: 1500;
			text-align: center;
			display: none;
		}

		/* éšè—å·¦ä¸‹è§’çš„æ¯”ä¾‹å°º */
		.openlime-scale {
			display: none !important;
		}
	</style>
</head>

<body>
	<div id="openlime"></div>
	<div id="errorMessage" class="error-message"></div>
	<div id="loadingMessage" class="loading-message">æ­£åœ¨åŠ è½½RTIé¡¹ç›®...</div>

	<script type="module" src="openlime.js"></script>

	<script>
		// ========================================
		// ğŸ”§ é…ç½®å‚æ•°åŒºåŸŸ - å¯æ ¹æ®éœ€è¦ä¿®æ”¹
		// ========================================
		
		/**
		 * ğŸŒ RTIé¡¹ç›®åŸºç¡€URLé…ç½®
		 * è¿™æ˜¯RTIé¡¹ç›®çš„åŸºç¡€è·¯å¾„ï¼Œæ‰€æœ‰é¡¹ç›®éƒ½ä¼šåœ¨æ­¤è·¯å¾„ä¸‹æŸ¥æ‰¾
		 * ä¾‹å¦‚ï¼šå¦‚æœbaseURLä¸º'/RTI'ï¼Œprjå‚æ•°ä¸º'SCMDQ'ï¼Œ
		 * åˆ™æœ€ç»ˆé¡¹ç›®è·¯å¾„ä¸ºï¼š/RTI/SCMDQ
		 */
		const BASE_URL = 'http://127.0.0.1:5500/';  // ğŸ‘ˆ åœ¨è¿™é‡Œä¿®æ”¹RTIé¡¹ç›®çš„åŸºç¡€è·¯å¾„
		
		// ========================================
		// å…¨å±€å˜é‡
		// ========================================
		let currentViewer = null;

		// ä»URLå‚æ•°è·å–é¡¹ç›®è·¯å¾„
		function getProjectFromURL() {
			const urlParams = new URLSearchParams(window.location.search);
			const project = urlParams.get('prj');

			console.log('åŸå§‹projectå‚æ•°:', project);
			console.log('é…ç½®çš„BASE_URL:', BASE_URL);

			// å¦‚æœæ²¡æœ‰æŒ‡å®šé¡¹ç›®ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰ç›®å½•
			if (!project) {
				console.log('æ²¡æœ‰projectå‚æ•°ï¼Œä½¿ç”¨å½“å‰ç›®å½•');
				return '.';
			}

			// å¦‚æœé¡¹ç›®åç§°ä¸åŒ…å«è·¯å¾„åˆ†éš”ç¬¦ï¼Œåˆ™è®¤ä¸ºæ˜¯BASE_URLä¸‹çš„RTIé¡¹ç›®
			// ä¾‹å¦‚: project=SCMDQ ä¼šè¢«è§£æä¸º BASE_URL/SCMDQ
			if (!project.includes('/') && !project.includes('\\') && project !== '.') {
				// ç¡®ä¿BASE_URLå’Œprojectä¹‹é—´æœ‰æ­£ç¡®çš„è·¯å¾„åˆ†éš”ç¬¦
				const separator = BASE_URL.endsWith('/') ? '' : '/';
				const result = `${BASE_URL}${separator}${project}`;
				console.log('ä½¿ç”¨BASE_URLæ„å»ºè·¯å¾„ï¼Œç»“æœ:', result);
				return result;
			}

			// å¦åˆ™ç›´æ¥ä½¿ç”¨æä¾›çš„è·¯å¾„ï¼ˆå®Œæ•´è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ï¼‰
			console.log('ç›´æ¥ä½¿ç”¨æä¾›çš„è·¯å¾„:', project);
			return project;
		}

		// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
		function showError(message) {
			const errorDiv = document.getElementById('errorMessage');
			const loadingDiv = document.getElementById('loadingMessage');
			loadingDiv.style.display = 'none';
			errorDiv.textContent = message;
			errorDiv.style.display = 'block';
			setTimeout(() => {
				errorDiv.style.display = 'none';
			}, 5000);
		}

		// æ˜¾ç¤ºåŠ è½½ä¿¡æ¯
		function showLoading(message) {
			const loadingDiv = document.getElementById('loadingMessage');
			loadingDiv.textContent = message;
			loadingDiv.style.display = 'block';
		}

		// éšè—åŠ è½½ä¿¡æ¯
		function hideLoading() {
			const loadingDiv = document.getElementById('loadingMessage');
			loadingDiv.style.display = 'none';
		}

		// è‡ªåŠ¨æ£€æµ‹RTIç±»å‹
		async function autodetect(basePath) {
			try {
				console.log('å¼€å§‹æ£€æµ‹RTIæ ¼å¼ï¼ŒåŸºç¡€è·¯å¾„:', basePath);

				let url = `${basePath}/plane_0.tzi`;
				console.log('æ£€æµ‹tarzoomæ ¼å¼ï¼ŒURL:', url);
				let response = await fetch(url);
				console.log('tarzoomæ£€æµ‹ç»“æœ:', response.status);
				if (response.status == 200)
					return "tarzoom";

				url = `${basePath}/plane_0.dzi`;
				console.log('æ£€æµ‹deepzoomæ ¼å¼ï¼ŒURL:', url);
				response = await fetch(url);
				console.log('deepzoomæ£€æµ‹ç»“æœ:', response.status);
				if (response.status == 200)
					return "deepzoom";

				url = `${basePath}/planes.tzi`;
				console.log('æ£€æµ‹itarzoomæ ¼å¼ï¼ŒURL:', url);
				response = await fetch(url);
				console.log('itarzoomæ£€æµ‹ç»“æœ:', response.status);
				if (response.status == 200)
					return "itarzoom";

				url = `${basePath}/plane_0.jpg`;
				console.log('æ£€æµ‹imageæ ¼å¼ï¼ŒURL:', url);
				response = await fetch(url);
				console.log('imageæ£€æµ‹ç»“æœ:', response.status);
				if (response.status == 200)
					return "image";

				throw new Error("æ— æ³•æ£€æµ‹åˆ°RTIæ ¼å¼");
			} catch (error) {
				console.error('è‡ªåŠ¨æ£€æµ‹å¤±è´¥:', error);
				return "image"; // é»˜è®¤è¿”å›imageæ ¼å¼
			}
		}

		// è‡ªåŠ¨æ£€æµ‹æ³•çº¿è´´å›¾
		async function autodetectNormals(layout, basePath) {
			try {
				if (layout == 'tarzoom') {
					let response = await fetch(`${basePath}/normals.tzi`);
					if (response.status == 200)
						return true;
				}
				if (layout == 'deepzoom') {
					let response = await fetch(`${basePath}/normals.dzi`);
					if (response.status == 200)
						return true;
				}
				if (layout == 'image') {
					let response = await fetch(`${basePath}/normals.jpg`);
					if (response.status == 200)
						return true;
				}
			} catch (error) {
				console.error('æ³•çº¿æ£€æµ‹å¤±è´¥:', error);
			}
			return false;
		}

		// åŠ è½½RTIé¡¹ç›®
		async function loadRTI(projectPath) {
			try {
				showLoading(`æ­£åœ¨åŠ è½½RTIé¡¹ç›®: ${projectPath}`);

				// æ¸…ç†ä¹‹å‰çš„viewer
				if (currentViewer) {
					const container = document.getElementById('openlime');
					container.innerHTML = '';
				}

				console.log('æ­£åœ¨åŠ è½½RTIé¡¹ç›®:', projectPath);

				// æ£€æµ‹RTIæ ¼å¼
				showLoading('æ­£åœ¨æ£€æµ‹RTIæ ¼å¼...');
				const layout = await autodetect(projectPath);
				console.log('æ£€æµ‹åˆ°çš„æ ¼å¼:', layout);

				// æ£€æµ‹æ³•çº¿è´´å›¾
				showLoading('æ­£åœ¨æ£€æµ‹æ³•çº¿è´´å›¾...');
				const normals = await autodetectNormals(layout, projectPath);
				console.log('æ³•çº¿è´´å›¾:', normals);

				// åˆ›å»ºæ–°çš„viewer
				showLoading('æ­£åœ¨åˆå§‹åŒ–æŸ¥çœ‹å™¨...');
				currentViewer = new OpenLIME.Viewer('#openlime', { 
					background: 'black',
					canvas: {
						preserveDrawingBuffer: true  // å¯ç”¨ç»˜åˆ¶ç¼“å†²åŒºä¿ç•™ï¼Œè§£å†³æˆªå›¾é»‘è‰²é—®é¢˜
					}
				});

				// åˆ›å»ºå›¾å±‚
				const layer = new OpenLIME.Layer({
					layout: layout,
					type: 'rti',
					url: `${projectPath}/info.json`,
					normals: normals
				});

				// æ·»åŠ å›¾å±‚åˆ°viewer
				currentViewer.canvas.addLayer('æ˜¾ç¤ºæ¨¡å¼', layer);

				// è®¾ç½®çš®è‚¤
				OpenLIME.Skin.setUrl('skin.svg');

				// åˆ›å»ºUI
				const ui = new OpenLIME.UIBasic(currentViewer, {
					skin: 'skin.svg',
					showLightDirections: true,
					pixelSize: 1.0  // è®¾ç½®åƒç´ å¤§å°ï¼Œç”¨äºæµ‹é‡å·¥å…·æ˜¾ç¤ºæ•°å€¼
				});

				ui.actions.light.active = true;
				ui.actions.layers.display = true;
				ui.actions.snapshot.display = true; // å¯ç”¨æˆªå›¾åŠŸèƒ½
				currentViewer.camera.maxFixedZoom = 1;

				hideLoading();
				console.log('RTIé¡¹ç›®åŠ è½½æˆåŠŸ');

			} catch (error) {
				console.error('åŠ è½½RTIé¡¹ç›®å¤±è´¥:', error);
				showError(`åŠ è½½RTIé¡¹ç›®å¤±è´¥: ${error.message}`);
			}
		}

		// åˆå§‹åŒ–
		async function init() {
			try {
				// ä»URLè·å–é¡¹ç›®è·¯å¾„
				const projectPath = getProjectFromURL();
				console.log('URLå‚æ•°è·å–çš„é¡¹ç›®è·¯å¾„:', projectPath);

				// åŠ è½½é¡¹ç›®
				await loadRTI(projectPath);

			} catch (error) {
				console.error('åˆå§‹åŒ–å¤±è´¥:', error);
				showError(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
			}
		}

		// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
		window.addEventListener('load', init);

	</script>
</body>

</html>