<!DOCTYPE html>
<html>

<head>
	<title>通用RTI查看器</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="UTF-8" />

	<link rel="icon" type="image/png"
		href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHdpZHRoPSI2MnB4IgogICBoZWlnaHQ9IjYycHgiCiAgIHZpZXdCb3g9IjAgMCA2MiA2MiIKICAgdmVyc2lvbj0iMS4xIj4KICA8Y2lyY2xlCiAgICAgdHJhbnNmb3JtPSJyb3RhdGUoNDUpIgogICAgIHN0eWxlPSJvcGFjaXR5OjE7ZmlsbDojZmFjZDVhO2ZpbGwtb3BhY2l0eToxIgogICAgIGN4PSI0My44NDA2MjIiCiAgICAgY3k9IjAiCiAgICAgcj0iMjguODgxNjk3IiAvPgogIDxwYXRoCiAgICAgZD0ibSAzOC4zOTk2OTUsMjcuMDUxODA5IC03LjkzNjQzNiwtNC42MTIwMjIgLTEuMjY1OTc2LC0xLjI2NTk3NiAtOC4wOTgzOTUsLTguMDk4Mzk1IC0yLjk1NzIzNCwtMi45NTcyMzQgYyAtMC43MDEzNTEsLTAuNzAxMzUwNSAtMS44MzA1OTcsLTAuNzAxMzU0IC0yLjUzMTk0OCwtMmUtNiBsIC01LjA1MzM4Niw1LjA1MzM4NiBjIC0wLjcwMTM1MjYsMC43MDEzNTIgLTAuNzAxMzQ5LDEuODMwNTk4IDNlLTYsMi41MzE5NDggbCAyLjk1NzIzMywyLjk1NzIzNSA4LjA5ODM5NSw4LjA5ODM5NSAxLjI2NTk3NSwxLjI2NTk3NSA0LjYxMjAyMiw3LjkzNjQzNyA1LjY3NDYzLDUuNjc0NjMxIDEwLjkwOTc0OCwtMTAuOTA5NzQ3IHoiCiAgICAgc3R5bGU9ImZpbGw6IzVmODJjMzsiLz4KICA8cGF0aCBkPSJtIDM4LjM5OTY5MiwyNy4wNTE4MTIgMi4yODEwNjksMi4yODEwNyAtMTAuOTA5NzQ0LDEwLjkwOTc0NCAtMi4yODEwNjksLTIuMjgxMDcgeiIKICAgICBzdHlsZT0iZmlsbDojNDE1YTg3OyIvPgogIDxjaXJjbGUKICAgICB0cmFuc2Zvcm09InJvdGF0ZSg0NSkiCiAgICAgcj0iMS43MTg0MjI4IgogICAgIGN5PSItMC4zMDk4MDYyOSIKICAgICBjeD0iMzYuOTc3MjI2IgogICAgIHN0eWxlPSJmaWxsOiMwMDAwMDA7ZmlsbC1vcGFjaXR5OjAuMjQ3NDc0NzYiLz4KICA8cGF0aAogICAgIGQ9Ik0gNTkuMDUzMDkyLDM3LjIwOTcgNDMuMTc3MjMsMzMuNjIzMjI1IDMzLjkwODMwMSw0Mi44OTIxNTMgYyAwLDAgMS45ODAxNjIsOS4yMjExNiAzLjQ0NjE1OSwxNi4xMDA5NTIgQSAyOC44ODE2OTcsMjguODgxNjk3IDAgMCAwIDUxLjMwNDI1OSw1MS4zMDQxOTkgMjguODgxNjk3LDI4Ljg4MTY5NyAwIDAgMCA1OS4wNTMwOTIsMzcuMjA5NyBaIgogICAgIHN0eWxlPSJmaWxsOiNmY2UwOTQ7Ii8+CiAgPHBhdGgKICAgICBkPSJtIDU2Ljc4NTczOCw0My41NzQwMDMgLTE0Ljk1OTA1NCwtOC42MDAyMzIgLTYuNDE0NzMsNi40MTQ3MyA4LjczMzI0MSwxNS4xMzczNzMgYSAyOC44ODE2OTcsMjguODgxNjk3IDAgMCAwIDcuMTU5MDY0LC01LjIyMTY3NSAyOC44ODE2OTcsMjguODgxNjk3IDAgMCAwIDUuNDgxNDc5LC03LjczMDE5NiB6IgogICAgIHN0eWxlPSJmaWxsOiNmZWY5ZDQ7Ii8+Cjwvc3ZnPgo=">
	<link rel="stylesheet" href="skin.css" />

	<style>
		html,
		body {
			margin: 0px;
			padding: 0px;
			height: 100%;
		}

		#openlime {
			position: relative;
			height: 100%
		}

		#openlime>canvas {
			width: 100%;
			height: 100%;
			/* this is important, it would cause firefox flickering! */
			overflow: hidden;
		}

		.error-message {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(255, 0, 0, 0.9);
			color: white;
			padding: 20px;
			border-radius: 10px;
			z-index: 2000;
			text-align: center;
			display: none;
		}

		.loading-message {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(0, 0, 0, 0.8);
			color: white;
			padding: 20px;
			border-radius: 10px;
			z-index: 1500;
			text-align: center;
			display: none;
		}
	</style>
</head>

<body>
	<div id="openlime"></div>
	<div id="errorMessage" class="error-message"></div>
	<div id="loadingMessage" class="loading-message">正在加载RTI项目...</div>

	<script type="module" src="openlime.js"></script>

	<script>
		// 全局变量
		let currentViewer = null;

		// 从URL参数获取项目路径
		function getProjectFromURL() {
			const urlParams = new URLSearchParams(window.location.search);
			const project = urlParams.get('prj');
			
			console.log('原始project参数:', project);
			
			// 如果没有指定项目，默认使用当前目录
			if (!project) {
				console.log('没有project参数，使用当前目录');
				return '.';
			}
			
			// 如果项目名称不包含路径分隔符，则认为是相对于上级目录的项目文件夹
			// 例如: project=SCMDQ 会被解析为 ../SCMDQ
			if (!project.includes('/') && !project.includes('\\') && project !== '.') {
				const result = `../${project}`;
				console.log('添加../前缀，结果:', result);
				return result;
			}
			
			// 否则直接使用提供的路径
			console.log('直接使用提供的路径:', project);
			return project;
		}

		// 显示错误信息
		function showError(message) {
			const errorDiv = document.getElementById('errorMessage');
			const loadingDiv = document.getElementById('loadingMessage');
			loadingDiv.style.display = 'none';
			errorDiv.textContent = message;
			errorDiv.style.display = 'block';
			setTimeout(() => {
				errorDiv.style.display = 'none';
			}, 5000);
		}

		// 显示加载信息
		function showLoading(message) {
			const loadingDiv = document.getElementById('loadingMessage');
			loadingDiv.textContent = message;
			loadingDiv.style.display = 'block';
		}

		// 隐藏加载信息
		function hideLoading() {
			const loadingDiv = document.getElementById('loadingMessage');
			loadingDiv.style.display = 'none';
		}

		// 自动检测RTI类型
		async function autodetect(basePath) {
			try {
				console.log('开始检测RTI格式，基础路径:', basePath);
				
				let url = `${basePath}/plane_0.tzi`;
				console.log('检测tarzoom格式，URL:', url);
				let response = await fetch(url);
				console.log('tarzoom检测结果:', response.status);
				if (response.status == 200)
					return "tarzoom";

				url = `${basePath}/plane_0.dzi`;
				console.log('检测deepzoom格式，URL:', url);
				response = await fetch(url);
				console.log('deepzoom检测结果:', response.status);
				if (response.status == 200)
					return "deepzoom";

				url = `${basePath}/planes.tzi`;
				console.log('检测itarzoom格式，URL:', url);
				response = await fetch(url);
				console.log('itarzoom检测结果:', response.status);
				if (response.status == 200)
					return "itarzoom";

				url = `${basePath}/plane_0.jpg`;
				console.log('检测image格式，URL:', url);
				response = await fetch(url);
				console.log('image检测结果:', response.status);
				if (response.status == 200)
					return "image";

				throw new Error("无法检测到RTI格式");
			} catch (error) {
				console.error('自动检测失败:', error);
				return "image"; // 默认返回image格式
			}
		}

		// 自动检测法线贴图
		async function autodetectNormals(layout, basePath) {
			try {
				if (layout == 'tarzoom') {
					let response = await fetch(`${basePath}/normals.tzi`);
					if (response.status == 200)
						return true;
				}
				if (layout == 'deepzoom') {
					let response = await fetch(`${basePath}/normals.dzi`);
					if (response.status == 200)
						return true;
				}
				if (layout == 'image') {
					let response = await fetch(`${basePath}/normals.jpg`);
					if (response.status == 200)
						return true;
				}
			} catch (error) {
				console.error('法线检测失败:', error);
			}
			return false;
		}

		// 加载RTI项目
		async function loadRTI(projectPath) {
			try {
				showLoading(`正在加载RTI项目: ${projectPath}`);
				
				// 清理之前的viewer
				if (currentViewer) {
					const container = document.getElementById('openlime');
					container.innerHTML = '';
				}

				console.log('正在加载RTI项目:', projectPath);
				
				// 检测RTI格式
				showLoading('正在检测RTI格式...');
				const layout = await autodetect(projectPath);
				console.log('检测到的格式:', layout);
				
				// 检测法线贴图
				showLoading('正在检测法线贴图...');
				const normals = await autodetectNormals(layout, projectPath);
				console.log('法线贴图:', normals);

				// 创建新的viewer
				showLoading('正在初始化查看器...');
				currentViewer = new OpenLIME.Viewer('#openlime', { background: 'black' });

				// 创建图层
				const layer = new OpenLIME.Layer({
					layout: layout,
					type: 'rti',
					url: `${projectPath}/info.json`,
					normals: normals
				});

				// 添加图层到viewer
				currentViewer.canvas.addLayer('显示模式', layer);
				
				// 设置皮肤
				OpenLIME.Skin.setUrl('skin.svg');
				
				// 创建UI
				const ui = new OpenLIME.UIBasic(currentViewer, { 
					skin: 'skin.svg', 
					showLightDirections: true 
				});
				
				ui.actions.light.active = true;
				ui.actions.layers.display = true;
				currentViewer.camera.maxFixedZoom = 1;
				
				hideLoading();
				console.log('RTI项目加载成功');
				
			} catch (error) {
				console.error('加载RTI项目失败:', error);
				showError(`加载RTI项目失败: ${error.message}`);
			}
		}

		// 初始化
		async function init() {
			try {
				// 从URL获取项目路径
				const projectPath = getProjectFromURL();
				console.log('URL参数获取的项目路径:', projectPath);
				
				// 加载项目
				await loadRTI(projectPath);
				
			} catch (error) {
				console.error('初始化失败:', error);
				showError(`初始化失败: ${error.message}`);
			}
		}

		// 页面加载完成后初始化
		window.addEventListener('load', init);

	</script>
</body>

</html>